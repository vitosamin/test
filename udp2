

sudo apt-get update && sudo apt-get upgrade
sudo apt-get install sudo pwgen ufw make git wireguard wireguard-tools tmux




sudo touch /etc/sysctl.d/local.conf
sudo nano /etc/sysctl.d/local.conf

net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv4.ip_forward=1


sudo sysctl --system





sudo mkdir /var/lib/vpn
sudo groupadd vpn-group

sudo useradd \
--home-dir /var/lib/vpn/cloak \
--create-home \
--system \
--shell /sbin/nologin \
--comment "VPN user" \
--groups vpn-group \
vpn-user


cd ~
mkdir udp2raw
cd udp2raw
wget https://github.com/wangyu-/udp2raw/releases/download/20230206.0/udp2raw_binaries.tar.gz
tar -xzf udp2raw_binaries.tar.gz
sudo mv udp2raw_amd64  /usr/local/bin/udp2raw_amd64
cd ~
rm -rf ~/udp2raw


pwgen 31 1|base64


#Проверяем 
sudo /usr/local/bin/udp2raw_amd64 -s -l 0.0.0.0:4096 -r 127.0.0.1:51820 -k "[vash_parol_dlya_udp2raw]=" --raw-mode faketcp -g

#видим, какое правило надо создать в iptables, создаём его
sudo iptables -I INPUT -p tcp -m tcp --dport 4096 -j DROP


sudo mkdir /etc/udp2raw
sudo touch /etc/udp2raw/server.conf
sudo nano /etc/udp2raw/server.conf

-s
# Listen address
-l 0.0.0.0:4096
# Remote address
-r 127.0.0.1:51820
-k [vash_parol_dlya_udp2raw]=
--raw-mode faketcp
-a

#права
sudo chmod 760 /etc/udp2raw
sudo chmod 640 /etc/udp2raw/server.conf

#юнит
sudo nano /etc/systemd/system/udp2raw-server.service

[Unit]
Description=UDP_2_RAW service
After=network.target syslog.target auditd.service wg-quick@wg0.service
StartLimitIntervalSec=0

[Service]
User=root
#Group=vpn-group
Type=simple
ExecStart=/usr/local/bin/udp2raw_amd64 --conf-file /etc/udp2raw/server.conf
Restart=always

[Install]
WantedBy=multi-user.target

# разрешим 
sudo setcap cap_net_raw+ep /usr/local/bin/udp2raw_amd64

# Сохраняем, активируем, запускаем, проверяем
sudo systemctl daemon-reload &&   sudo systemctl enable udp2raw-server.service && sudo systemctl start udp2raw-server.service && sudo systemctl status udp2raw-server.service
 


###CLIENT


sudo apt-get update && sudo apt-get upgrade
sudo apt-get install sudo pwgen ufw make git wireguard wireguard-tools tmux



sudo touch /etc/sysctl.d/local.conf
sudo nano /etc/sysctl.d/local.conf

net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv4.ip_forward=1


sudo sysctl --system




cd ~
mkdir udp2raw
cd udp2raw
wget https://github.com/wangyu-/udp2raw/releases/download/20230206.0/udp2raw_binaries.tar.gz
tar -xzf udp2raw_binaries.tar.gz
sudo mv udp2raw_amd64  /usr/local/bin/udp2raw_amd64
cd ~
rm -rf ~/udp2raw




sudo mkdir /etc/udp2raw
sudo touch /etc/udp2raw/client.conf
sudo nano /etc/udp2raw/client.conf

-c
# Listen address
-l 0.0.0.0:51820
# Remote address
-r [Remote_VDS_IP]:4096
-k [vash_parol_dlya_udp2raw]=
--raw-mode faketcp
-a


# права

sudo chmod 760 /etc/udp2raw
sudo chmod 640 /etc/udp2raw/client.conf

# Проверим
sudo /usr/local/bin/udp2raw_amd64 --conf-file /etc/udp2raw/client.conf -g
sudo iptables -I INPUT -p tcp -m tcp --dport 51820 -j DROP

# разрешим
sudo setcap cap_net_raw+ep /usr/local/bin/udp2raw_amd64

# проверим
sudo -u root /usr/local/bin/udp2raw_amd64 --conf-file /etc/udp2raw/client.conf

# Создадим юнит

sudo touch /etc/systemd/system/udp2raw-client.service
sudo nano /etc/systemd/system/udp2raw-client.service

[Unit]
Description=UDP_2_RAW service
After=network.target syslog.target auditd.service wg-quick@wg0.service
StartLimitIntervalSec=0

[Service]
User=vpn-user
Group=vpn-group
Type=simple
ExecStart=/usr/local/bin/udp2raw_amd64 --conf-file /etc/udp2raw/client.conf
Restart=always

[Install]
WantedBy=multi-user.target

# Сохраняем, активируем, запускаем, проверяем
sudo systemctl daemon-reload && sudo systemctl enable udp2raw-client.service && sudo systemctl start udp2raw-client.service && sudo systemctl status udp2raw-client.service 
